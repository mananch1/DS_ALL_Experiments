<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doctor Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .form-input { @apply w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent sm:text-sm transition-shadow bg-gray-50; }
        .btn-primary { @apply w-full inline-flex items-center justify-center py-2.5 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors disabled:bg-blue-300; }
        .card { @apply bg-white p-6 sm:p-8 rounded-xl shadow-lg border border-gray-200; }
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            z-index: 50;
        }
        .toast.show { opacity: 1; transform: translateY(0); }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #ffffff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="toast-notification" class="toast"></div>

    <div id="app" class="max-w-7xl w-full">
        <header class="text-center mb-10">
            <div class="inline-flex items-center justify-center bg-blue-100 rounded-full p-3">
                <svg class="h-10 w-10 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                     <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                </svg>
            </div>
            <h1 class="text-4xl font-extrabold text-gray-900 mt-4">Doctor's Portal</h1>
            <p class="text-lg text-gray-500 mt-1">Manage and view patient records with ease.</p>
        </header>

        <main class="space-y-8">
            <div class="max-w-2xl mx-auto w-full">
                <div class="card">
                     <div class="border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                            <button id="add-record-tab-button" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-blue-600 border-blue-500">Add Record</button>
                            <button id="view-records-tab-button" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 border-transparent">View Records</button>
                        </nav>
                    </div>

                    <div id="add-record-container" class="mt-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">New Patient Record</h2>
                        <form id="add-record-form" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="patient-uuid" class="block text-sm font-medium text-gray-700 mb-1">Patient UUID</label>
                                <input id="patient-uuid" name="patient_uuid" type="text" required class="form-input font-mono" placeholder="Enter patient's unique ID">
                            </div>
                            <div>
                                <label for="doctor-name" class="block text-sm font-medium text-gray-700 mb-1">Your Name, M.D.</label>
                                <input id="doctor-name" name="doctor_name" type="text" required class="form-input" placeholder="e.g., Smith">
                            </div>
                            <div class="sm:col-span-1">
                                <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Description / Diagnosis</label>
                                <textarea id="description" name="description" rows="3" required class="form-input"></textarea>
                            </div>
                            <div class="sm:col-span-1">
                                <label for="prescription" class="block text-sm font-medium text-gray-700 mb-1">Prescription</label>
                                <textarea id="prescription" name="prescription" rows="3" required class="form-input"></textarea>
                            </div>
                            <div class="sm:col-span-2 ">
                                <label for="resources-used" class="block text-sm font-medium text-gray-700 mb-1">Resources Used (Optional)</label>
                                <input id="resources-used" name="resources_used" type="text" placeholder="e.g., X-Ray, Blood Test" class="form-input">
                            </div>
                            <div class="sm:col-span-2">
                                <button id="add-record-btn" type="submit" class="btn-primary mt-2">
                                    <span class="btn-text">Submit Record</span>
                                    <div class="loader hidden"></div>
                                </button>
                            </div>
                        </form>
                    </div>

                    <div id="view-records-container" class="mt-6 hidden">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">Find Patient Records</h2>
                        <form id="view-records-form" class="space-y-4">
                            <div>
                                <label for="view-patient-uuid" class="block text-sm font-medium text-gray-700 mb-1">Patient UUID</label>
                                <input id="view-patient-uuid" type="text" required class="form-input font-mono" placeholder="Enter patient's unique ID">
                            </div>
                            <div>
                                <button id="fetch-records-btn" type="submit" class="btn-primary mt-2">
                                    <span class="btn-text">Fetch Records</span>
                                    <div class="loader hidden"></div>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div id="results-container" class="max-w-4xl mx-auto w-full hidden">
                <div class="card min-h-[300px]">
                    <h2 id="records-title" class="text-xl font-bold text-gray-800 mb-4">Patient Record History</h2>
                    <div id="records-display-message" class="text-center text-gray-500 pt-16">
                         </div>
                    <div id="records-display-list" class="space-y-6 mt-4"></div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const API_URL = 'http://127.0.0.1:5000';
        let currentPatientUUID = null; 

        // DOM Elements
        const addRecordTabButton = document.getElementById('add-record-tab-button');
        const viewRecordsTabButton = document.getElementById('view-records-tab-button');
        const addRecordContainer = document.getElementById('add-record-container');
        const viewRecordsContainer = document.getElementById('view-records-container');
        const addRecordForm = document.getElementById('add-record-form');
        const viewRecordsForm = document.getElementById('view-records-form');
        const addRecordBtn = document.getElementById('add-record-btn');
        const fetchRecordsBtn = document.getElementById('fetch-records-btn');
        const resultsContainer = document.getElementById('results-container');
        const recordsTitle = document.getElementById('records-title');
        const recordsDisplayMessage = document.getElementById('records-display-message');
        const recordsDisplayList = document.getElementById('records-display-list');
        const toastNotification = document.getElementById('toast-notification');

        // --- Event Listeners ---
        addRecordTabButton.addEventListener('click', () => switchTab('add'));
        viewRecordsTabButton.addEventListener('click', () => switchTab('view'));
        addRecordForm.addEventListener('submit', handleAddRecord);
        viewRecordsForm.addEventListener('submit', (e) => handleViewRecords(e));

        // --- Tab Switching Logic ---
        function switchTab(tab) {
            const activeClasses = ['text-blue-600', 'border-blue-500'];
            const inactiveClasses = ['text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300', 'border-transparent'];
            if (tab === 'add') {
                addRecordTabButton.classList.add(...activeClasses);
                addRecordTabButton.classList.remove(...inactiveClasses);
                viewRecordsTabButton.classList.add(...inactiveClasses);
                viewRecordsTabButton.classList.remove(...activeClasses);
                addRecordContainer.classList.remove('hidden');
                viewRecordsContainer.classList.add('hidden');
            } else {
                viewRecordsTabButton.classList.add(...activeClasses);
                viewRecordsTabButton.classList.remove(...inactiveClasses);
                addRecordTabButton.classList.add(...inactiveClasses);
                addRecordTabButton.classList.remove(...activeClasses);
                viewRecordsContainer.classList.remove('hidden');
                addRecordContainer.classList.add('hidden');
            }
        }

        // --- API Handlers & Logic ---
        async function handleAddRecord(e) {
            e.preventDefault();
            toggleButtonLoading(addRecordBtn, true);
            
            const formData = new FormData(addRecordForm);
            const payload = Object.fromEntries(formData.entries());

            try {
                const response = await fetch(`${API_URL}/record`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();

                if (response.ok) {
                    showToast('âœ… Record added successfully!', 'bg-green-500 text-white');
                    addRecordForm.reset();
                    if (payload.patient_uuid === currentPatientUUID) {
                        await handleViewRecords(null, payload.patient_uuid);
                    }
                } else {
                    showToast(`Error: ${data.error || data.message}`, 'bg-red-500 text-white');
                }
            } catch (error) {
                 showToast('Error: Could not connect to the server.', 'bg-red-500 text-white');
            } finally {
                toggleButtonLoading(addRecordBtn, false);
            }
        }

        async function handleViewRecords(e, uuid = null) {
            if (e) e.preventDefault();
            toggleButtonLoading(fetchRecordsBtn, true);
            
            const patientUUID = uuid || document.getElementById('view-patient-uuid').value;
            
            resultsContainer.classList.remove('hidden');
            recordsDisplayMessage.innerHTML = `<div class="loader mx-auto mt-16 border-t-blue-500"></div><p class="mt-4 text-gray-500">Fetching records...</p>`;
            recordsDisplayList.innerHTML = '';
            
            try {
                const response = await fetch(`${API_URL}/records/${patientUUID}`);
                
                if (response.ok) {
                    const records = await response.json();
                    currentPatientUUID = patientUUID; 
                    renderRecords(records, patientUUID);
                    document.getElementById('patient-uuid').value = patientUUID;
                } else {
                    const errorData = await response.json();
                    renderRecords([], patientUUID, `Error: ${errorData.error}`);
                }
            } catch (error) {
                renderRecords([], patientUUID, `Error: Could not connect to the server.`);
            } finally {
                toggleButtonLoading(fetchRecordsBtn, false);
            }
        }

        // --- UI Rendering & Helpers ---
        function toggleButtonLoading(button, isLoading) {
            const btnText = button.querySelector('.btn-text');
            const loader = button.querySelector('.loader');
            if (isLoading) {
                button.disabled = true;
                btnText.classList.add('hidden');
                loader.classList.remove('hidden');
            } else {
                button.disabled = false;
                btnText.classList.remove('hidden');
                loader.classList.add('hidden');
            }
        }
        
        function showToast(message, style) {
            toastNotification.textContent = message;
            toastNotification.className = `toast show ${style}`;
            setTimeout(() => {
                toastNotification.classList.remove('show');
            }, 3000);
        }

        function renderRecords(records, uuid, error = null) {
            recordsTitle.innerHTML = `Record History for <span class="font-mono text-blue-600">${uuid.substring(0, 8)}...</span>`;
            recordsDisplayList.innerHTML = ''; 

            if (error) {
                 recordsDisplayMessage.innerHTML = `<div class="text-center text-red-500 pt-16"><p>${error}</p></div>`;
                 return;
            }

            if (records.length === 0) {
                recordsDisplayMessage.innerHTML = `
                    <div class="text-center text-gray-500 pt-16">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>
                        <p class="mt-2 text-sm font-medium">No records found for this patient.</p>
                        <p class="text-xs">You can add one using the 'Add Record' tab.</p>
                    </div>`;
                return;
            }
            
            recordsDisplayMessage.innerHTML = '';
            recordsDisplayList.innerHTML = records.map(rec => `
                <div class="border-l-4 border-blue-500 pl-4 py-3 bg-gray-50 rounded-r-lg transition-transform hover:scale-[1.02]">
                    <div class="flex justify-between items-start">
                        <h3 class="font-bold text-gray-800">Record by Dr. ${rec.doctor_name}</h3>
                        <p class="text-xs text-gray-500 whitespace-nowrap ml-4">${new Date(rec.timestamp).toLocaleString()}</p>
                    </div>
                    <div class="text-sm mt-2 space-y-1 text-gray-700">
                        <p><strong>Diagnosis:</strong> ${rec.description}</p>
                        <p><strong>Prescription:</strong> ${rec.prescription}</p>
                        <p><strong>Resources Used:</strong> ${rec.resources_used || 'N/A'}</p>
                    </div>
                </div>
            `).join('');
        }
    </script>
</body>
</html>